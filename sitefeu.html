<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Les Épreuves de l’Abysse</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
body{
  background:black;
  color:white;
  font-family:'Press Start 2P', monospace;
  margin:0;
  text-align:center;
}

h1{margin-top:20px;font-size:16px;}

#game-container{margin-top:20px;}
#counter{margin-top:10px;font-size:14px;}

.square{
  width:30px;height:30px;
  display:inline-block;
  margin:4px;
  border:2px solid white;
  cursor:pointer;
}

.camera{
  width:70px;height:90px;
  border:2px solid white;
  display:inline-block;
  margin:8px;
  position:relative;
  cursor:pointer;
}

.anim{
  position:absolute;
  width:100%;height:100%;
  background:white;
  display:none;
}

.box{
  border:4px solid white;
  width:90%;
  max-width:700px;
  margin:30px auto;
  padding:20px;
}

input{
  background:black;
  color:white;
  border:2px solid white;
  padding:10px;
  font-family:'Press Start 2P';
  width:80%;
}

button{
  margin-top:15px;
  padding:10px 20px;
  background:black;
  color:white;
  border:2px solid white;
  font-family:'Press Start 2P';
  cursor:pointer;
}

button:hover{
  background:white;
  color:black;
}

.message{
  position:absolute;
  font-size:14px;
  animation:fade 1s forwards;
}

@keyframes fade{
  0%{opacity:1;}
  100%{opacity:0; top:0;}
}

.finalScene{
  display:none;
  height:100vh;
  justify-content:center;
  align-items:center;
  flex-direction:column;
}

#letterFinal{
  font-size:140px;
  margin-top:40px;
  animation:blink 1s infinite;
}

@keyframes blink{
  0%{opacity:1;}
  50%{opacity:0;}
  100%{opacity:1;}
}
</style>
</head>

<body>

<h1>Les Épreuves de l’Abysse</h1>
<div id="counter">Score : 0</div>
<div id="game-container"></div>

<div class="finalScene" id="finalScene">
  <div id="entityText"></div>
  <div id="letterFinal"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* ---------------- CONFIG ---------------- */

const firebaseConfig = {
  apiKey: "AIzaSyCLUNQhx8h0dHmiI3rqJ6QPuDju0Aa4zAo",
  authDomain: "trailer-90acb.firebaseapp.com",
  databaseURL: "https://trailer-90acb-default-rtdb.firebaseio.com",
  projectId: "trailer-90acb",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const finalLetter = "I"; // CHANGE I S M A C

const entityMessages = {
  "I":"Tu as marché dans l’ombre sans réclamer la lumière. L’Abysse t’a reconnu.",
  "S":"Tu doutes mais tu avances. L’Abysse t’a éprouvé.",
  "M":"Tes silences sont plus lourds que les cris. L’Abysse t’a entendu.",
  "A":"Tu cherches au-delà du visible. L’Abysse t’a observé.",
  "C":"Tu refuses les limites imposées. L’Abysse t’a choisi."
};

const failMessages=["raté","encore faux","trop faible","recommence","concentre toi"];

let score=0;
let current=0;

/* --------------- UTIL --------------- */

function updateScore(){
  document.getElementById("counter").textContent="Score : "+score;
}

function showFail(){
  const m=document.createElement("div");
  m.className="message";
  m.style.left=Math.random()*window.innerWidth+"px";
  m.style.top=Math.random()*window.innerHeight+"px";
  m.textContent=failMessages[Math.floor(Math.random()*failMessages.length)];
  document.body.appendChild(m);
  setTimeout(()=>m.remove(),1000);
}

/* --------------- ÉPREUVE 1 NARRATIVE --------------- */

function epreuveNarrative(next){
  const container=document.getElementById("game-container");
  container.innerHTML=`
  <div class="box">
  <div id="text"></div>
  <h3>À qui s’adresse le message ?</h3>
  <input id="rep"><br>
  <button onclick="checkNarrative()">VALIDER</button>
  <div id="err"></div>
  </div>`;

  const text=`Bonjour... Vous prenez votre premier poste de nuit.
Les animatroniques errent librement.
Ils ne vous voient pas comme humain.
Ils vous verront comme un endosquelette.
À qui ce message est-il destiné ?`;

  let i=0;
  function type(){
    if(i<text.length){
      document.getElementById("text").innerHTML+=text[i];
      i++;
      setTimeout(type,20);
    }
  }
  type();

  window.checkNarrative=function(){
    const val=document.getElementById("rep").value.toLowerCase().trim();
    if(val.includes("gardien")){
      score++; updateScore();
      db.ref("lettres/"+finalLetter).set(true);
      next();
    }else{
      score=0; updateScore(); showFail();
    }
  }
}

/* --------------- ÉPREUVE 2 FNAF --------------- */

function epreuveFnaf(next){
  const c=document.getElementById("game-container");
  c.innerHTML="<h2>Animatroniques</h2>";
  let cams=[];
  for(let i=0;i<4;i++){
    const cam=document.createElement("div");
    cam.className="camera";
    const anim=document.createElement("div");
    anim.className="anim";
    cam.appendChild(anim);
    c.appendChild(cam);
    cams.push(cam);
  }
  let active;
  function spawn(){
    cams.forEach(c=>c.firstChild.style.display="none");
    active=Math.floor(Math.random()*4);
    cams[active].firstChild.style.display="block";
  }
  cams.forEach((cam,i)=>{
    cam.onclick=function(){
      if(i===active){
        score++; updateScore();
        next();
      }else{
        score=0; updateScore(); showFail();
      }
    }
  });
  spawn();
}

/* --------------- ÉPREUVE 3 MÉMOIRE --------------- */

function epreuveMemoire(next){
  const c=document.getElementById("game-container");
  c.innerHTML="<h2>Mémoire</h2>";
  const seq=[0,1,2,3].sort(()=>0.5-Math.random());
  let user=[];
  for(let i=0;i<4;i++){
    const s=document.createElement("div");
    s.className="square";
    c.appendChild(s);
    s.onclick=function(){
      user.push(i);
      if(user[user.length-1]!==seq[user.length-1]){
        score=0; updateScore(); showFail(); user=[];
      }
      if(user.length===seq.length){
        score++; updateScore(); next();
      }
    }
  }
}

/* --------------- ÉPREUVE 4 COFFRES --------------- */

function epreuveCoffres(next){
  const c=document.getElementById("game-container");
  c.innerHTML="<h2>Coffres</h2>";
  const good=Math.floor(Math.random()*20);
  for(let i=0;i<20;i++){
    const s=document.createElement("div");
    s.className="square";
    c.appendChild(s);
    s.onclick=function(){
      if(i===good){
        score++; updateScore(); next();
      }else{
        score=0; updateScore(); showFail();
      }
    }
  }
}

/* --------------- ÉPREUVE 5 CALCULS --------------- */

function epreuveCalcul(next){
  const c=document.getElementById("game-container");
  let a=Math.floor(Math.random()*20)+10;
  let b=Math.floor(Math.random()*10)+1;
  c.innerHTML=`<h2>Calcul</h2>
  ${a} + ${b} = ?
  <br><input id="calc"><br>
  <button onclick="checkCalc()">VALIDER</button>`;

  window.checkCalc=function(){
    if(parseInt(document.getElementById("calc").value)==a+b){
      score++; updateScore(); next();
    }else{
      score=0; updateScore(); showFail();
    }
  }
}

/* --------------- FINAL --------------- */

function finalScene(){
  document.getElementById("game-container").style.display="none";
  const scene=document.getElementById("finalScene");
  scene.style.display="flex";
  document.getElementById("entityText").textContent=entityMessages[finalLetter];
  document.getElementById("letterFinal").textContent=finalLetter;
}

/* --------------- FLOW --------------- */

const epreuves=[
  epreuveNarrative,
  epreuveFnaf,
  epreuveMemoire,
  epreuveCoffres,
  epreuveCalcul
];

function next(){
  current++;
  if(current<epreuves.length){
    epreuves[current](next);
  }else{
    finalScene();
  }
}

epreuves[0](next);

</script>
</body>
</html>
