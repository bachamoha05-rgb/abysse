<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Défis de l'Abysse</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
body {background:black;color:white;font-family:'Press Start 2P',monospace;margin:0;padding:0;text-align:center;overflow:hidden;}
h1{margin-top:20px;font-size:16px;}
#game-container{margin-top:20px;position:relative;}
#counter{font-size:16px;margin-top:10px;}
#letterFinal{font-size:120px;margin-top:30px;display:none;animation:blink 1s infinite;}
@keyframes blink{0%{opacity:1;}50%{opacity:0;}100%{opacity:1;}}
.message{position:absolute;font-size:16px;font-weight:bold;pointer-events:none;animation:fadeOut 1s forwards;}
.message.success{color:yellow;}
.message.fail{color:red;}
@keyframes fadeOut{0%{opacity:1;}100%{opacity:0;top:0;}}
.finalScene{display:none;flex-direction:column;justify-content:center;align-items:center;height:100vh;}
#entityText{font-size:14px;margin-bottom:40px;min-height:40px;transition:opacity 0.5s ease;}
.camera{width:60px;height:80px;border:2px solid white;margin:5px;position:relative;cursor:pointer;background:black;display:inline-block;}
.animatronique{width:100%;height:100%;position:absolute;top:0;left:0;background:white;display:none;}
.square{width:30px;height:30px;display:inline-block;margin:2px;border:2px solid white;cursor:pointer;user-select:none;}
#coffres{width:700px;margin:20px auto;}
.box {border:6px solid white;width:90%;max-width:600px;margin:40px auto;padding:20px;}
#text {font-size:14px;line-height:1.8em;text-align:left;min-height:300px;}
input {background:black;color:white;border:3px solid white;padding:14px;font-family:'Press Start 2P',monospace;font-size:16px;width:90%;margin-top:20px;box-sizing:border-box;}
button {margin-top:20px;padding:16px 24px;font-family:'Press Start 2P',monospace;font-size:16px;background:black;color:white;border:3px solid white;cursor:pointer;}
button:hover {background:white;color:black;}
#error {margin-top:20px;color:red;font-size:14px;}
</style>
</head>
<body>

<h1>Défis de l'Abysse</h1>
<div id="game-container">
  <div id="currentEpreuve">Épreuve 1</div>
  <div id="counter">Score : 0</div>
</div>

<div class="finalScene" id="finalScene">
  <div id="entityText"></div>
  <div id="letterFinal"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCLUNQhx8h0dHmiI3rqJ6QPuDju0Aa4zAo",
  authDomain: "trailer-90acb.firebaseapp.com",
  databaseURL: "https://trailer-90acb-default-rtdb.firebaseio.com",
  projectId: "trailer-90acb",
  storageBucket: "trailer-90acb.firebasestorage.app",
  messagingSenderId: "216077694665",
  appId: "1:216077694665:web:e6090a278b656f7d2f7f18"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const finalLetter = "I"; // à changer pour chaque site : I,S,M,A,C
let currentEpreuveIndex=0, score=0;
const totalEpreuves=5;
const epreuves=[];
const failMessages=["raté","trop guez","fait un effort","bro plz","encore raté"];
function showMessage(text,type){
  const msg=document.createElement('div');
  msg.className='message '+type;
  msg.textContent=text;
  msg.style.left=Math.random()*(window.innerWidth-100)+'px';
  msg.style.top=Math.random()*(window.innerHeight-50)+'px';
  document.body.appendChild(msg);
  setTimeout(()=>{document.body.removeChild(msg);},1000);
}
function updateScore(){document.getElementById('counter').textContent="Score : "+score;}

// ---------------- ÉPREUVES ----------------

// --- Épreuve 1 : Texte narratif ---
function epreuve1(callback){
  const container=document.getElementById('game-container');
  container.innerHTML=`<h2>Épreuve 1 : Dernière enregistrement</h2>
  <div class="box"><div id="text"></div><h3>À qui s'adresse le message ?</h3>
  <input type="text" id="answer" placeholder="Gardien de nuit"><br>
  <button id="submitBtn">VALIDER</button>
  <div id="error"></div>
  <div id="result">${finalLetter}</div></div>`;

  const fullText = `Bonjour? Boonnjouuur?... (texte complet ici)`; // Texte narratif complet
  const textElement=document.getElementById("text");
  let index=0;
  function typeWriter(){if(index<fullText.length){textElement.innerHTML+=fullText.charAt(index);index++;setTimeout(typeWriter,15);}}
  typeWriter();

  document.getElementById("submitBtn").onclick=checkAnswer;
  function checkAnswer(){
    const answer=document.getElementById("answer").value.trim().toLowerCase();
    const result=document.getElementById("result");
    const error=document.getElementById("error");
    if(answer==="à un gardien de nuit"||answer==="gardien de nuit"||answer==="un gardien de nuit"){
      result.style.display="block";error.textContent="";
      db.ref("lettres/"+finalLetter).set(true);
      score++;updateScore();showMessage("+1 point","success");
      callback();
    } else {result.style.display="none";error.textContent="... Mauvaise réponse.";}
  }
}

// --- Épreuve 2 : Mini-jeu FNAF ---
function epreuve2(callback){
  const container=document.getElementById('game-container');
  container.innerHTML="<h2>Épreuve 2 : Animatroniques</h2>";
  const cameras=[];
  for(let i=0;i<4;i++){const c=document.createElement('div');c.className='camera';container.appendChild(c);const anim=document.createElement('div');anim.className='animatronique';c.appendChild(anim);cameras.push(c);}
  let current=-1;
  function spawn(){cameras.forEach(c=>c.firstChild.style.display='none');current=Math.floor(Math.random()*cameras.length);cameras[current].firstChild.style.display='block';}
  cameras.forEach((c,i)=>c.onclick=()=>{
    if(i===current){score++;updateScore();showMessage("+1 point","success");spawn();}
    else{score=Math.max(0,score-1);updateScore();showMessage(failMessages[Math.floor(Math.random()*failMessages.length)],"fail");}
  });
  spawn();
}

// --- Épreuve 3 : Mémoire ---
function epreuve3(callback){
  const container=document.getElementById('game-container');
  container.innerHTML="<h2>Épreuve 3 : Mémoire</h2><div id='memory'></div>";
  const memory=document.getElementById('memory');
  const sequence=[],userSequence=[];
  for(let i=0;i<5;i++) sequence.push(Math.floor(Math.random()*4));
  for(let i=0;i<sequence.length;i++){const s=document.createElement('div');s.className='square';s.style.background='white';memory.appendChild(s);}
  let idx=0;
  function showSeq(){
    const squares=document.querySelectorAll('#memory .square');
    if(idx<sequence.length){
      squares[sequence[idx]].style.background='yellow';
      setTimeout(()=>{squares[sequence[idx]].style.background='white';idx++;showSeq();},500);
    } else userClick();
  }
  function userClick(){
    const squares=document.querySelectorAll('#memory .square');
    squares.forEach((sq,i)=>sq.onclick=()=>{
      userSequence.push(i);
      sq.style.background='green';
      if(userSequence[userSequence.length-1]!==sequence[userSequence.length-1]){
        showMessage(failMessages[Math.floor(Math.random()*failMessages.length)],"fail");
        score=0;updateScore();
        userSequence.length=0;idx=0;showSeq();
      } else if(userSequence.length===sequence.length){
        score++;updateScore();showMessage("+1 point","success");
        callback();
      }
    });
  }
  showSeq();
}

// --- Épreuve 4 : Coffres ---
function epreuve4(callback){
  const container=document.getElementById('game-container');
  container.innerHTML="<h2>Épreuve 4 : Trouve le coffre</h2><div id='coffres'></div>";
  const coffreDiv=document.getElementById('coffres');
  const coffreCorrect=Math.floor(Math.random()*30);let attempts=0;
  for(let i=0;i<30;i++){const c=document.createElement('div');c.className='square';coffreDiv.appendChild(c);
    c.onclick=function(){
      if(i===coffreCorrect){this.style.background='green';score++;updateScore();showMessage("+1 point","success");callback();}
      else{this.style.background='red';attempts++;score=Math.max(0,score-1);updateScore();showMessage(failMessages[Math.floor(Math.random()*failMessages.length)],"fail");if(attempts>=10){coffreDiv.innerHTML='';attempts=0;showMessage("Réinitialisation...","fail");epreuve4(callback);}}
    }
  }
}

// --- Épreuve 5 : Calculs mentaux ---
function epreuve5(callback){
  const container=document.getElementById('game-container');
  container.innerHTML="<h2>Épreuve 5 : Calculs mentaux</h2><div id='calc'></div>";
  const calcDiv=document.getElementById('calc'); let num=1, answer=0;
  const calculs=[];
  for(let i=0;i<14;i++){
    let a=Math.floor(Math.random()*20)+10,b=Math.floor(Math.random()*10)+1,op=['+','-','*','/'][Math.floor(Math.random()*4)];
    calculs.push({a,b,op});
  }
  calculs.push({a:0,b:0,op:'final'}); // Question finale
  let idx=0;
  function showCalc(){
    if(idx>=calculs.length) return callback();
    const c=calculs[idx]; calcDiv.innerHTML="";
    if(c.op==='final'){calcDiv.innerHTML=`On naît avec rien + on repart avec ... = ?<br><input id="calcInput" type="number"><button id="calcBtn">VALIDER</button>`;}
    else{calcDiv.innerHTML=`${c.a} ${c.op} ${c.b} = ?<br><input id="calcInput" type="number"><button id="calcBtn">VALIDER</button>`;}
    document.getElementById('calcBtn').onclick=()=>{
      const val=parseFloat(document.getElementById('calcInput').value);
      let correct;
      if(c.op==='+') correct=c.a+c.b;
      else if(c.op==='-') correct=c.a-c.b;
      else if(c.op==='*') correct=c.a*c.b;
      else if(c.op==='/') correct=parseFloat((c.a/c.b).toFixed(2));
      else if(c.op==='final') correct=0;
      if(val===correct){score++;updateScore();showMessage("+1 point","success");idx++;showCalc();}
      else{score=0;updateScore();showMessage(failMessages[Math.floor(Math.random()*failMessages.length)],"fail");idx=0;showCalc();}
    }
  }
  showCalc();
}

// ------------------------- PROGRESSION -------------------------
epreuves.push(epreuve1,epreuve2,epreuve3,epreuve4,epreuve5);
function startNextEpreuve(){if(currentEpreuveIndex<totalEpreuves){epreuves[currentEpreuveIndex](()=>{currentEpreuveIndex++;startNextEpreuve();});}else startFinalScene();}
startNextEpreuve();

// ------------------------- SCÈNE FINALE -------------------------
function startFinalScene(){
  document.getElementById('game-container').style.display="none";
  const scene=document.getElementById('finalScene');scene.style.display="flex";
  const text=document.getElementById('entityText');
  const letterDisplay=document.getElementById('letterFinal');
  const messages={"I":"Tu avances sans voir… mais tu sens.","S":"Tu observes là où d'autres parlent.","M":"Tu portes ce que les autres oublient.","A":"Tu tends vers ce qui dépasse.","C":"Tu brises l'ordre établi."};
  text.textContent=messages[finalLetter];
  setTimeout(()=>{letterDisplay.textContent=finalLetter;letterDisplay.style.opacity=1;letterDisplay.style.transform="scale(1.2)";},3000);
}
</script>
</body>
</html>
